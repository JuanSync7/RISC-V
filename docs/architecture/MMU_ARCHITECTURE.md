# Memory Management Unit (MMU) Architecture

## 1. Overview
The Memory Management Unit (MMU) is a critical component responsible for translating virtual addresses generated by the CPU into physical addresses used by the memory subsystem. It provides memory protection, virtual memory capabilities, and efficient memory access.

## 2. Key Features
- Virtual-to-Physical Address Translation
- Translation Lookaside Buffer (TLB) for fast lookups
- Page Table Walk mechanism for TLB misses
- Memory Protection (read, write, execute permissions)
- Support for configurable page sizes (e.g., 4KB)
- Integrated Instruction and Data TLBs (ITLB and DTLB) within a unified TLB structure.

## 3. MMU Operation
### 3.1. Address Translation Process
1.  CPU generates a virtual address.
2.  The MMU attempts to find a matching entry in the TLB.
3.  **TLB Hit**: If found, the corresponding physical address is retrieved directly.
4.  **TLB Miss**: If not found, the MMU initiates a hardware-managed page table walk to retrieve the translation from memory.
5.  The retrieved translation is stored in the TLB for future use.
6.  The physical address is then used to access the memory hierarchy (caches, main memory).

### 3.2. Translation Lookaside Buffer (TLB)
- **Purpose**: A cache for page table entries, speeding up virtual-to-physical address translation.
- **Structure**: A set-associative cache storing virtual page numbers, physical page numbers, and access permissions.
- **Management**: TLB entries are managed by hardware (for page table walks) and can be invalidated by software (e.g., on context switches).

### 3.3. Page Table Walk
- When a TLB miss occurs, the MMU performs a hardware-managed walk through the page tables in main memory to find the required translation.
- The page table base address is stored in the `satp` Control and Status Register (CSR).

## 4. Memory Protection
The MMU enforces memory access permissions (read, write, execute) based on the page table entries. Any unauthorized access triggers a page fault exception.

## 5. Integration with Pipeline
The MMU is instantiated within the `core_subsystem.sv` module.
- **Fetch Stage**: Requests instruction virtual addresses to the MMU for translation. The MMU provides the physical address to the instruction cache.
- **Execute Stage**: Requests data virtual addresses (for loads/stores) to the MMU for translation. The MMU provides the physical address to the data cache.

## 6. Configuration
The MMU's behavior and features are configurable via parameters defined in `mmu_pkg.sv` (e.g., TLB size, associativity, page size) and through the `satp` CSR.

## 7. Exception Handling
The MMU generates exceptions for:
- Instruction Page Fault
- Load Page Fault
- Store/AMO Page Fault
- Instruction Access Fault
- Load Access Fault
- Store/AMO Access Fault

## 8. Future Enhancements
- Support for larger virtual/physical address spaces (e.g., Sv39, Sv48).
- Advanced TLB replacement policies (e.g., true LRU, pseudo-LRU).
- Hardware performance counters for MMU activity (TLB hits/misses, PTW cycles).
- More comprehensive CSR management unit for all CSRs.
